# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
# Use a package of configuration called an orb.
orbs:
  # Declare a dependency on the welcome-orb
  welcome: circleci/welcome-orb@0.4.1
  sonarqube: onehq/sonarqube@0.3.0
# Orchestrate or schedule a set of jobs
commands:
  scanner:
    parameters:
      app:
        type: string
        description: "Github repo"
    steps:
    - run:
        name: Install Sonarqube scanner
        command: |

          wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-3.2.0.1227-linux.zip
          unzip sonar-scanner-cli-3.2.0.1227-linux.zip
    - run:
        name: Run Sonarqube scanner
        command: |
          export SONAR_SCANNER_OPTS="-Xmx2048m"
          eval ./sonar-scanner-3.2.0.1227-linux/bin/sonar-scanner -Dsonar.projectKey=<< parameters.app >> \
          -Dsonar.sources=. \
          -Dsonar.sourceEncoding=US-ASCII \
          -Dsonar.exclusions=vendor/bundle/** \
          -Dsonar.host.url=https://sonarqube.onehq.com \
          -Dsonar.projectVersion=${CIRCLE_BRANCH} \
          -Dsonar.login=${SONARQUBE_TOKEN} $SONAR_SCANNER_OPTS_CUSTOM

workflows:
  # Name the workflow "welcome"
  welcome:
    # Run the welcome/run job in its own container
    jobs:
      - welcome/run
